# Fireproof Connect - Docker Compose Configuration
# Generated by /vibes:connect skill
# Start with: docker compose up --build

services:
  # Cloud Backend (Wrangler dev with R2 storage)
  cloud-backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.cloud-backend
    container_name: fireproof-cloud-backend
    ports:
      - "8909:8909"
    environment:
      # Server config
      ENDPOINT_PORT: "8909"
      NODE_ENV: development

      # Session tokens
      CLOUD_SESSION_TOKEN_PUBLIC: __CLOUD_SESSION_TOKEN_PUBLIC__

      # Protocol settings
      VERSION: FP-MSG-1.0
      FP_DEBUG: "true"
      MAX_IDLE_TIME: "300"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8909/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dashboard (Frontend + Backend API with Clerk auth)
  dashboard:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dashboard
    container_name: fireproof-dashboard
    ports:
      - "7370:7370"
    environment:
      # Server config
      PORT: "7370"
      NODE_ENV: development
      ENVIRONMENT: dev

      # Session tokens (must match cloud-backend)
      CLOUD_SESSION_TOKEN_PUBLIC: __CLOUD_SESSION_TOKEN_PUBLIC__
      CLOUD_SESSION_TOKEN_SECRET: __CLOUD_SESSION_TOKEN_SECRET__

      # Clerk authentication
      CLERK_SECRET_KEY: __CLERK_SECRET_KEY__
      CLERK_PUBLISHABLE_KEY: __CLERK_PUBLISHABLE_KEY__
      VITE_CLERK_PUBLISHABLE_KEY: __CLERK_PUBLISHABLE_KEY__
      CLERK_PUB_JWT_URL: __CLERK_PUB_JWT_URL__

      # Device ID CA keys
      DEVICE_ID_CA_PRIV_KEY: __DEVICE_ID_CA_PRIV_KEY__
      DEVICE_ID_CA_CERT: __DEVICE_ID_CA_CERT__

      # Limits
      MAX_LEDGERS: "50"
      MAX_TENANTS: "100"
      MAX_ADMIN_USERS: "10"
      MAX_MEMBER_USERS: "50"
      MAX_INVITES: "100"
      MAX_APPID_BINDINGS: "50"

      # Cloud backend URL
      FP_ENDPOINT: http://cloud-backend:8909
    depends_on:
      cloud-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:7370/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  wrangler_state:

networks:
  default:
    name: fireproof-network
