# Fireproof Connect - Docker Compose Configuration
# Generated by /vibes:connect skill
# Start with: docker compose up --build

services:
  connect:
    build:
      context: ../packages/connect-token
      dockerfile: Dockerfile
    ports:
      - "7370:7370"
    environment:
      PORT: "7370"
      NODE_ENV: development
      ENVIRONMENT: dev

      # Session tokens (must match cloud-backend)
      CLOUD_SESSION_TOKEN_PUBLIC: __CLOUD_SESSION_TOKEN_PUBLIC__
      CLOUD_SESSION_TOKEN_SECRET: __CLOUD_SESSION_TOKEN_SECRET__

      # Clerk authentication
      CLERK_SECRET_KEY: __CLERK_SECRET_KEY__
      CLERK_PUBLISHABLE_KEY: __CLERK_PUBLISHABLE_KEY__
      VITE_CLERK_PUBLISHABLE_KEY: __CLERK_PUBLISHABLE_KEY__
      CLERK_PUB_JWT_URL: __CLERK_PUB_JWT_URL__

      # Device ID CA keys
      DEVICE_ID_CA_PRIV_KEY: __DEVICE_ID_CA_PRIV_KEY__
      DEVICE_ID_CA_CERT: __DEVICE_ID_CA_CERT__
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7370/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  cloud:
    build:
      context: ../packages/cloud-backend
      dockerfile: Dockerfile
    ports:
      - "8909:8909"
    environment:
      PORT: "8909"
      NODE_ENV: development

      # Session tokens (must match connect service)
      CLOUD_SESSION_TOKEN_PUBLIC: __CLOUD_SESSION_TOKEN_PUBLIC__
      CLOUD_SESSION_TOKEN_SECRET: __CLOUD_SESSION_TOKEN_SECRET__
    depends_on:
      connect:
        condition: service_started
