<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vibes Live Preview</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --vibes-black: #0f172a;
      --vibes-near-black: #1a1a1a;
      --vibes-cream: #fffff0;
      --vibes-menu-bg: #CCCDC8;
      --vibes-blue: #009ACE;
      --vibes-red: #DA291C;
      --vibes-yellow: #eab308;
      --vibes-green: #22c55e;
      --vibes-white: #fff;
      --grid-size: 32px;
      --grid-color: rgba(255, 255, 255, 0.5);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: black;
      color: var(--vibes-near-black);
      height: 100vh;
      overflow: hidden;
      margin: 0;
    }
    .black-border-wrapper {
      position: fixed;
      inset: 0;
      background: black;
    }
    .black-border-inner {
      height: calc(100% - 20px);
      width: calc(100% - 20px);
      margin: 10px;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: var(--vibes-menu-bg);
    }

    /* === HEADER === */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0;
      background: var(--vibes-cream);
      border-bottom: 1px solid black;
      height: 64px;
      flex-shrink: 0;
      font-family: 'Alte Haas Grotesk', 'Inter', sans-serif;
      box-shadow: 0px 1px 0px 0px var(--vibes-cream);
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    .header-left { display: flex; align-items: center; height: 100%; }
    .header-right { display: flex; align-items: center; height: 100%; }
    .vibes-pill-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 63px;
    }
    .vibes-pill { height: 36px; cursor: pointer; padding: 0 12px; }

    /* Navbar expand-on-hover buttons */
    .navbar-button-wrapper {
      display: flex;
      align-items: center;
      height: 63px;
    }
    .navbar-button-wrapper button {
      display: flex;
      align-items: center;
      height: 63px;
      width: 64px;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
      padding: 0;
      position: relative;
      font-family: 'Alte Haas Grotesk', 'Inter', sans-serif;
    }
    .navbar-button-icon {
      width: 64px;
      height: 63px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 22px;
    }
    .navbar-button-label {
      color: var(--vibes-cream);
      font-size: 14px;
      font-weight: bold;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      opacity: 0;
      width: 0;
      padding: 0;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
      display: inline-block;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }
    .navbar-button-wrapper:hover button {
      width: 180px !important;
      justify-content: flex-start !important;
    }
    .navbar-button-wrapper:hover .navbar-button-label {
      opacity: 1 !important;
      width: auto !important;
      max-width: 120px !important;
      padding: 0 16px 0 4px !important;
    }
    .navbar-button-wrapper:hover .navbar-button-icon {
      animation: wiggle 0.6s ease-in-out infinite;
    }
    @keyframes wiggle {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-5deg); }
      75% { transform: rotate(5deg); }
    }

    /* === MAIN SPLIT === */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* === PREVIEW PANEL === */
    .preview-panel {
      flex: 0 0 72%;
      position: relative;
      background: #fff;
      overflow: hidden;
      border-right: 2px solid var(--vibes-near-black);
    }
    .preview-panel.thinking { opacity: 0.5; transition: opacity 0.3s; }
    .preview-panel.updated {
      animation: flash-border 0.6s ease-out;
    }
    @keyframes flash-border {
      0% { box-shadow: inset 0 0 0 3px var(--vibes-green); }
      100% { box-shadow: inset 0 0 0 0px transparent; }
    }
    .preview-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* === SPLITTER === */
    .splitter {
      width: 6px;
      background: var(--vibes-near-black);
      cursor: col-resize;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    .splitter:hover, .splitter.dragging { background: var(--vibes-blue); }

    /* === CHAT PANEL === */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--vibes-menu-bg);
      background-image:
        linear-gradient(var(--grid-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
      background-size: var(--grid-size) var(--grid-size);
      min-width: 280px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .chat-bubble {
      max-width: 85%;
      padding: 0.65rem 0.9rem;
      border-radius: 12px;
      font-size: 0.8125rem;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
      border: 2px solid var(--vibes-near-black);
    }
    .chat-bubble.user {
      align-self: flex-end;
      background: var(--vibes-cream);
      color: var(--vibes-near-black);
      box-shadow: 4px 4px 0px 0px var(--vibes-blue), 4px 4px 0px 2px var(--vibes-near-black);
      border-bottom-right-radius: 4px;
    }
    .chat-bubble.assistant {
      align-self: flex-start;
      background: var(--vibes-cream);
      color: var(--vibes-near-black);
      box-shadow: 4px 4px 0px 0px var(--vibes-yellow), 4px 4px 0px 2px var(--vibes-near-black);
      border-bottom-left-radius: 4px;
    }
    .chat-bubble.error {
      align-self: center;
      background: var(--vibes-cream);
      color: var(--vibes-red);
      box-shadow: 4px 4px 0px 0px var(--vibes-red), 4px 4px 0px 2px var(--vibes-near-black);
      font-size: 0.75rem;
    }
    .chat-bubble.system {
      align-self: center;
      background: transparent;
      color: #555;
      font-size: 0.75rem;
      font-style: italic;
      border: none;
      box-shadow: none;
    }
    .thinking-indicator {
      align-self: flex-start;
      width: 85%;
      padding: 0.65rem 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: var(--vibes-cream);
      border: 2px solid var(--vibes-near-black);
      border-radius: 12px;
      box-shadow: 4px 4px 0px 0px var(--vibes-yellow), 4px 4px 0px 2px var(--vibes-near-black);
    }
    .thinking-header {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .thinking-dots {
      display: flex;
      gap: 4px;
    }
    .thinking-dot {
      width: 7px;
      height: 7px;
      background: var(--vibes-blue);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .thinking-dot:nth-child(2) { animation-delay: 0.16s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.32s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }
    .thinking-stage {
      font-size: 0.75rem;
      color: #555;
      font-weight: 600;
    }
    .thinking-progress-bar {
      width: 100%;
      height: 7px;
      background: rgba(0,0,0,0.1);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--vibes-near-black);
    }
    .thinking-progress-fill {
      height: 100%;
      background: var(--vibes-blue);
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }
    .thinking-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .thinking-pct {
      font-size: 0.6875rem;
      color: #555;
      font-weight: 700;
    }
    .thinking-timer {
      font-size: 0.6875rem;
      color: #555;
      font-variant-numeric: tabular-nums;
    }
    .thinking-cancel {
      background: var(--vibes-cream);
      border: 2px solid var(--vibes-near-black);
      color: var(--vibes-red);
      padding: 0.25rem 0.6rem;
      border-radius: 8px;
      font-size: 0.6875rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 3px 3px 0px 0px var(--vibes-red), 3px 3px 0px 2px var(--vibes-near-black);
    }
    .thinking-cancel:hover { transform: translate(2px, 2px); box-shadow: 1px 1px 0px 0px var(--vibes-red), 1px 1px 0px 2px var(--vibes-near-black); }
    .thinking-cancel:active { transform: translate(3px, 3px); box-shadow: none; }

    /* === CHAT INPUT === */
    .chat-input-bar {
      display: flex;
      padding: 0.75rem;
      gap: 0.5rem;
      border-top: 2px solid var(--vibes-near-black);
      background: var(--vibes-menu-bg);
    }
    .chat-input {
      flex: 1;
      background: var(--vibes-cream);
      border: 2px solid var(--vibes-near-black);
      color: var(--vibes-near-black);
      padding: 0.5rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8125rem;
      outline: none;
      resize: none;
      font-family: inherit;
      min-height: 38px;
      max-height: 120px;
    }
    .chat-input:focus { border-color: var(--vibes-blue); box-shadow: 0 0 0 2px rgba(0,154,206,0.25); }
    .chat-input::placeholder { color: #999; }
    .chat-send {
      background: var(--vibes-cream);
      border: 2px solid var(--vibes-near-black);
      color: var(--vibes-near-black);
      padding: 0 1rem;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 700;
      transition: all 0.15s ease;
      flex-shrink: 0;
      letter-spacing: 0.05em;
      box-shadow: 4px 4px 0px 0px var(--vibes-blue), 4px 4px 0px 2px var(--vibes-near-black);
    }
    .chat-send:hover { transform: translate(2px, 2px); box-shadow: 2px 2px 0px 0px var(--vibes-blue), 2px 2px 0px 2px var(--vibes-near-black); }
    .chat-send:active { transform: translate(4px, 4px); box-shadow: none; }
    .chat-send:disabled { background: #ddd; color: #999; cursor: not-allowed; box-shadow: none; transform: none; border-color: #aaa; }

    /* === THEME MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--vibes-cream);
      border: 3px solid var(--vibes-near-black);
      border-radius: 12px;
      width: 90vw;
      max-width: 800px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 8px 10px 0px 0px var(--vibes-blue), 8px 10px 0px 3px var(--vibes-near-black);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 2px solid var(--vibes-near-black);
    }
    .modal-header h2 {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--vibes-near-black);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .modal-close {
      background: var(--vibes-cream);
      border: 2px solid var(--vibes-near-black);
      color: var(--vibes-near-black);
      font-size: 1.1rem;
      cursor: pointer;
      padding: 0.15rem 0.5rem;
      line-height: 1;
      border-radius: 8px;
      box-shadow: 3px 3px 0px 0px var(--vibes-red), 3px 3px 0px 2px var(--vibes-near-black);
      transition: all 0.15s;
    }
    .modal-close:hover { transform: translate(2px, 2px); box-shadow: 1px 1px 0px 0px var(--vibes-red), 1px 1px 0px 2px var(--vibes-near-black); }
    .modal-create-btn {
      background: var(--vibes-cream);
      border: 2px solid var(--vibes-near-black);
      color: var(--vibes-near-black);
      padding: 0.3rem 0.75rem;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.05em;
      transition: all 0.15s;
      box-shadow: 3px 3px 0px 0px var(--vibes-blue), 3px 3px 0px 2px var(--vibes-near-black);
    }
    .modal-create-btn:hover { transform: translate(2px, 2px); box-shadow: 1px 1px 0px 0px var(--vibes-blue), 1px 1px 0px 2px var(--vibes-near-black); }
    .modal-create-btn:active { transform: translate(3px, 3px); box-shadow: none; }
    .modal-create-btn:disabled { background: #ddd; color: #999; cursor: not-allowed; box-shadow: none; transform: none; border-color: #aaa; }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: var(--vibes-menu-bg);
      background-image:
        linear-gradient(var(--grid-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
      background-size: var(--grid-size) var(--grid-size);
    }
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    .theme-card {
      background: var(--vibes-cream);
      border: 2px solid var(--vibes-near-black);
      border-radius: 8px;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 4px 4px 0px 0px var(--vibes-blue), 4px 4px 0px 2px var(--vibes-near-black);
    }
    .theme-card:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0px 0px var(--vibes-blue), 2px 2px 0px 2px var(--vibes-near-black);
    }
    .theme-card-name {
      font-size: 0.8125rem;
      font-weight: 700;
      color: var(--vibes-near-black);
      margin-bottom: 0.25rem;
    }
    .theme-card-mood {
      font-size: 0.6875rem;
      color: #555;
      margin-bottom: 0.35rem;
    }
    .theme-card-for {
      font-size: 0.625rem;
      color: var(--vibes-blue);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .theme-search {
      width: 100%;
      background: var(--vibes-cream);
      border: 2px solid var(--vibes-near-black);
      color: var(--vibes-near-black);
      padding: 0.6rem 0.85rem;
      border-radius: 12px;
      font-size: 0.8125rem;
      outline: none;
      font-family: inherit;
      margin-bottom: 1rem;
    }
    .theme-search:focus { border-color: var(--vibes-blue); box-shadow: 0 0 0 2px rgba(0,154,206,0.25); }
    .theme-search::placeholder { color: #999; }
    .theme-section-label {
      font-size: 0.6875rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--vibes-near-black);
      margin-bottom: 0.5rem;
    }
    .theme-section-label.all {
      color: #555;
      margin-top: 1rem;
    }
    .theme-card.recommended {
      border-color: var(--vibes-blue);
    }
    .theme-card-badge {
      display: inline-block;
      font-size: 0.5625rem;
      background: var(--vibes-blue);
      color: var(--vibes-cream);
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      margin-left: 0.35rem;
      vertical-align: middle;
      font-weight: 700;
      text-transform: uppercase;
    }
    .theme-swatches {
      display: flex;
      gap: 4px;
      margin-bottom: 0.4rem;
      align-items: center;
    }
    .theme-swatch-bar {
      flex: 1;
      height: 24px;
      border-radius: 4px;
      display: flex;
      overflow: hidden;
      border: 2px solid var(--vibes-near-black);
    }
    .theme-swatch-segment {
      flex: 1;
      min-width: 0;
    }

    /* === CREATE THEME === */
    .create-theme-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .create-theme-input {
      flex: 1;
      background: var(--vibes-cream);
      border: 2px solid var(--vibes-near-black);
      color: var(--vibes-near-black);
      padding: 0.6rem 0.85rem;
      border-radius: 12px;
      font-size: 0.8125rem;
      outline: none;
      font-family: inherit;
    }
    .create-theme-input:focus { border-color: var(--vibes-blue); box-shadow: 0 0 0 2px rgba(0,154,206,0.25); }
    .create-theme-input::placeholder { color: #999; }
    .image-picker {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .image-card {
      aspect-ratio: 1;
      border-radius: 8px;
      border: 2px solid var(--vibes-near-black);
      overflow: hidden;
      cursor: pointer;
      position: relative;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--vibes-cream);
      box-shadow: 4px 4px 0px 0px var(--vibes-yellow), 4px 4px 0px 2px var(--vibes-near-black);
    }
    .image-card:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0px 0px var(--vibes-yellow), 2px 2px 0px 2px var(--vibes-near-black);
    }
    .image-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-card.loading { cursor: default; }
    .image-card.loading:hover { transform: none; box-shadow: 4px 4px 0px 0px var(--vibes-yellow), 4px 4px 0px 2px var(--vibes-near-black); }
    .image-card.failed { border-color: var(--vibes-red); box-shadow: 4px 4px 0px 0px var(--vibes-red), 4px 4px 0px 2px var(--vibes-near-black); cursor: default; }
    .image-card.failed:hover { transform: none; }
    .image-card .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(0,0,0,0.1);
      border-top-color: var(--vibes-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .create-status {
      text-align: center;
      font-size: 0.8125rem;
      color: #555;
      padding: 0.5rem 0;
      font-weight: 600;
    }
    .create-status.success { color: var(--vibes-green); }
    .create-status.error { color: var(--vibes-red); }
  </style>
</head>
<body>
<div class="black-border-wrapper">
<div class="black-border-inner">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="vibes-pill-wrap">
        <svg class="vibes-pill" xmlns="http://www.w3.org/2000/svg" viewBox="0 118 600 185" fill="currentColor">
          <!-- Outer black pill -->
          <path fill-rule="evenodd" clip-rule="evenodd" fill="#000" d="M293.353,298.09c-41.038,0-82.078,0.125-123.115-0.077c-11.993-0.06-24.011-0.701-35.964-1.703c-15.871-1.331-29.73-7.937-41.948-17.946c-16.769-13.736-27.207-31.417-30.983-52.7c-4.424-24.93,1.404-47.685,16.506-67.913c11.502-15.407,26.564-26.1,45.258-30.884c7.615-1.949,15.631-2.91,23.501-3.165c20.08-0.652,40.179-0.853,60.271-0.879c69.503-0.094,139.007-0.106,208.51,0.02c14.765,0.026,29.583,0.097,44.28,1.313c36.984,3.059,61.78,23.095,74.653,57.301c17.011,45.199-8.414,96.835-54.29,111.864c-7.919,2.595-16.165,3.721-24.434,3.871c-25.614,0.467-51.234,0.742-76.853,0.867C350.282,298.197,321.817,298.09,293.353,298.09z"/>
          <!-- Inner white pill (stretched) -->
          <path fill="#fff" fill-rule="evenodd" clip-rule="evenodd" d="M165.866,285.985c-7.999-0.416-19.597-0.733-31.141-1.687c-15.692-1.297-28.809-8.481-40.105-19.104c-12.77-12.008-20.478-26.828-22.714-44.177c-3.048-23.644,3.384-44.558,19.646-62.143c9.174-9.92,20.248-17.25,33.444-20.363c7.786-1.837,15.944-2.399,23.973-2.828c9.988-0.535,121.023-0.666,131.021-0.371c10.191,0.301,20.433,0.806,30.521,2.175c12.493,1.696,23.132,7.919,32.552,16.091c14.221,12.337,22.777,27.953,25.184,46.594c2.822,21.859-2.605,41.617-16.777,58.695c-9.494,11.441-21.349,19.648-35.722,23.502c-6.656,1.785-13.724,2.278-20.647,2.77C286.914,285.721,177.682,285.667,165.866,285.985z"/>
          <!-- VIBES letters -->
          <path fill-rule="evenodd" clip-rule="evenodd" fill="var(--vibes-black)" d="M181.891,205.861c0-5.043-0.001-10.086,0-15.129c0.001-5.046,1.679-7.539,6.606-7.695c9.292-0.294,18.653-1.051,27.888,0.707c7.614,1.449,11.523,5.954,11.902,13.446c0.066,1.312-0.313,2.752-0.857,3.966c-1.401,3.123-1.399,6.266-0.673,9.507c0.301,1.342,0.443,2.723,0.787,4.053c1.274,4.925-1.78,10.114-6.085,11.937c-3.111,1.318-6.561,2.327-9.909,2.497c-7.303,0.37-14.639,0.136-21.96,0.101c-1.165-0.005-2.345-0.181-3.488-0.422c-2.657-0.56-4.162-2.962-4.197-6.801C181.854,216.639,181.891,211.25,181.891,205.861z M204.442,192.385c-2.757,0-5.514,0-8.271,0c-3.695,0-5.151,1.669-4.712,5.403c0.369,3.14,1.05,3.735,4.225,3.737c5.024,0.004,10.05,0.109,15.07-0.014c2.028-0.05,4.167-0.27,6.04-0.98c3.182-1.207,3.639-4.256,1.008-6.455c-1.073-0.896-2.659-1.509-4.06-1.618C210.659,192.22,207.544,192.385,204.442,192.385z M204.334,211.104c0,0.045,0,0.091,0,0.137c-3.101,0-6.203-0.055-9.302,0.037c-0.823,0.024-2.257,0.373-2.344,0.794c-0.447,2.154-0.959,4.444-0.639,6.563c0.276,1.822,2.447,1.451,3.882,1.441c5.989-0.042,11.98-0.118,17.961-0.385c1.416-0.063,2.859-0.79,4.176-1.441c1.79-0.886,1.833-2.475,1.029-4.046c-1.166-2.276-3.297-3.024-5.677-3.081C210.394,211.049,207.363,211.104,204.334,211.104z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" fill="var(--vibes-black)" d="M291.409,229.748c-3.621-0.394-7.838-0.587-11.94-1.379c-3.577-0.69-6.343-2.991-8.213-6.163c-1.763-2.99-0.301-5.6,3.139-5.292c2.287,0.205,4.512,1.129,6.758,1.755c6.281,1.751,12.643,1.892,19.053,0.951c0.667-0.098,1.31-0.416,1.941-0.686c1.502-0.644,2.55-1.682,2.581-3.415c0.031-1.74-1.195-2.749-2.579-3.132c-2.298-0.637-4.688-1.021-7.065-1.273c-5.062-0.536-10.252-0.401-15.187-1.475c-9.677-2.105-11.678-10.53-10.101-16.009c1.62-5.625,5.911-8.92,11.318-9.73c8.388-1.257,16.925-1.491,25.279,0.654c3.702,0.951,6.615,3.072,7.883,6.931c0.918,2.792-0.332,4.6-3.268,4.357c-1.684-0.139-3.367-0.676-4.974-1.248c-6.711-2.387-13.572-2.897-20.569-1.783c-1.001,0.159-2.146,0.414-2.875,1.034c-0.901,0.766-2.016,1.981-1.98,2.964c0.041,1.128,0.995,2.733,1.991,3.206c1.81,0.857,3.925,1.279,5.948,1.441c5.152,0.41,10.356,0.296,15.479,0.905c7.98,0.949,13.779,9.833,11.241,17.125c-1.959,5.628-6.44,8.489-12.143,9.322C299.455,229.344,295.715,229.419,291.409,229.748z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" fill="var(--vibes-black)" d="M235.786,208.14c0-6.905-0.01-13.809,0.004-20.714c0.007-3.474,0.948-4.428,4.415-3.758c6.62,1.279,13.232,2.651,19.759,4.331c1.7,0.438,3.404,1.896,4.515,3.341c1.777,2.31,0.433,5.367-2.463,5.745c-1.86,0.243-3.819-0.138-5.717-0.368c-2.183-0.264-4.339-0.783-6.525-0.976c-1.572-0.138-3.065,0.375-3.8,1.959c-0.76,1.638-0.319,3.329,0.942,4.34c1.619,1.296,3.522,2.327,5.447,3.128c2.146,0.894,4.539,1.207,6.66,2.145c1.446,0.64,2.982,1.687,3.786,2.981c0.689,1.11,0.928,3.094,0.378,4.202c-0.492,0.991-2.32,1.795-3.579,1.825c-2.238,0.052-4.483-0.652-6.741-0.832c-1.614-0.127-3.333-0.203-4.865,0.212c-2.574,0.699-3.225,3.013-1.719,5.218c1.396,2.044,3.431,3.141,5.757,3.761c2.791,0.744,5.637,1.315,8.373,2.222c3.19,1.058,4.791,3.496,4.801,6.723c0.011,3.365-1.759,5.021-5.138,4.424c-4.402-0.778-8.759-1.81-13.134-2.735c-2.357-0.499-4.718-0.981-7.069-1.511c-3.263-0.737-4.132-1.805-4.141-5.154c-0.019-6.836-0.006-13.672-0.006-20.508C235.747,208.141,235.766,208.14,235.786,208.14z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" fill="var(--vibes-black)" d="M135.138,229.842c-2.941-0.084-5.296-1.462-6.684-3.9c-1.827-3.21-3.328-6.618-4.81-10.011c-3.55-8.128-7.021-16.291-10.486-24.455c-0.48-1.132-0.902-2.329-1.087-3.536c-0.417-2.72,1.238-4.585,3.938-4.119c1.591,0.275,3.569,0.98,4.45,2.173c2.226,3.015,4.175,6.299,5.784,9.69c2.208,4.654,3.898,9.552,6.032,14.244c0.628,1.379,2.009,2.416,3.045,3.609c0.892-1.159,2.042-2.201,2.63-3.498c2.697-5.953,5.22-11.985,7.841-17.974c1.423-3.252,3.089-6.418,6.532-7.905c1.238-0.535,3.012-0.712,4.184-0.214c0.81,0.344,1.377,2.126,1.385,3.271c0.009,1.458-0.479,2.997-1.059,4.371c-4.227,10.013-8.504,20.005-12.833,29.974c-0.79,1.819-1.762,3.589-2.875,5.229C139.73,228.848,137.671,229.894,135.138,229.842z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" fill="var(--vibes-black)" d="M164.636,206.263c0-6.691,0.054-13.383-0.036-20.073c-0.024-1.851,0.716-2.67,2.449-2.81c0.274-0.022,0.549-0.054,0.823-0.076c5.488-0.445,6.091,0.105,6.091,5.562c0,12.348,0,24.695,0,37.043c0,2.887-0.354,3.405-3.222,3.618c-1.628,0.121-3.338-0.001-4.91-0.408c-0.593-0.153-1.265-1.408-1.278-2.171c-0.096-5.584-0.034-11.172-0.022-16.759c0.002-1.308,0-2.617,0-3.926C164.566,206.263,164.601,206.263,164.636,206.263z"/>
          <!-- DIY letters -->
          <path fill-rule="evenodd" clip-rule="evenodd" fill="#fff" d="M388.313,210.147c0-6.356,0.034-12.713-0.023-19.069c-0.015-1.61,0.359-2.472,2.19-2.346c2.887,0.198,5.809,0.045,8.671,0.398c4.396,0.542,8.019,4.294,8.144,8.904c0.223,8.142,0.265,16.304-0.074,24.439c-0.248,5.945-4.552,9.662-10.491,9.831c-1.999,0.057-4.003-0.081-6.006-0.09c-1.746-0.008-2.439-0.853-2.428-2.584C388.34,223.136,388.313,216.642,388.313,210.147z M393.418,210.324c-0.037,0-0.075,0-0.114,0c0,4.55-0.038,9.101,0.015,13.65c0.031,2.688,0.926,3.439,3.56,3.239c3.273-0.248,5.493-2.511,5.534-6.04c0.082-7.099,0.054-14.2-0.033-21.299c-0.041-3.268-1.739-5.241-4.87-6.092c-2.68-0.728-4.025,0.161-4.07,2.896C393.364,201.226,393.418,205.775,393.418,210.324z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" fill="#fff" d="M478.079,200.8c0.674-1.566,1.121-2.53,1.506-3.519c0.673-1.73,1.252-3.5,1.981-5.205c0.315-0.737,0.766-1.654,1.407-1.961c1.094-0.523,2.388-0.63,3.598-0.912c0.205,1.142,0.798,2.381,0.537,3.404c-0.606,2.388-1.448,4.756-2.507,6.984c-3.981,8.389-4.352,17.254-3.78,26.282c0.091,1.438,0.031,2.899-0.105,4.335c-0.14,1.473-0.989,2.428-2.542,2.497c-1.514,0.067-2.311-0.903-2.54-2.23c-0.232-1.348-0.394-2.754-0.277-4.108c0.94-10.972-1.116-21.38-5.626-31.375c-0.586-1.298-0.899-2.762-1.093-4.183c-0.233-1.712,0.825-2.592,2.379-1.843c1.164,0.561,2.345,1.55,2.973,2.657c1.078,1.897,1.712,4.043,2.568,6.07C476.918,198.547,477.37,199.361,478.079,200.8z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" fill="#fff" d="M440.516,210.627c0,6.281,0.007,12.563-0.004,18.844c-0.004,2.067-0.805,3.038-2.531,3.015c-1.877-0.025-2.365-1.136-2.359-2.876c0.046-12.631,0.019-25.263,0.029-37.895c0.002-2.592,0.525-3.205,2.419-3.148c1.856,0.057,2.479,1.03,2.466,2.803C440.484,197.788,440.515,204.208,440.516,210.627z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" fill="#fff" d="M416.875,210.721c0.068-3.305,1.849-5.306,4.727-5.309c2.765-0.003,4.924,2.404,4.816,5.371c-0.106,2.956-2.355,5.212-5.12,5.138C418.626,215.849,416.813,213.718,416.875,210.721z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" fill="#fff" d="M449.933,210.636c0.102-3.331,1.886-5.279,4.778-5.22c2.67,0.055,4.829,2.432,4.762,5.243c-0.073,3.021-2.404,5.36-5.242,5.261C451.606,215.829,449.84,213.657,449.933,210.636z"/>
        </svg>
      </div>
    </div>
    <div class="header-right">
      <div class="navbar-button-wrapper">
        <button id="themeBtn" style="background:#5398c9" onclick="openThemeModal()">
          <div class="navbar-button-icon">
            <svg width="35" height="35" viewBox="0 0 35 35" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="17.5" cy="17.5" r="17.5" fill="#231F20"/>
              <path d="M17.5 8C12.25 8 8 11.36 8 15.5c0 2.48 1.73 4.67 4.35 6.03-.15 1.22-.78 2.34-1.85 3.07a.5.5 0 00.3.9c2.1 0 3.82-.88 4.93-2.04.56.03 1.14.04 1.77.04 5.25 0 9.5-3.36 9.5-7.5S22.75 8 17.5 8z" fill="var(--vibes-cream)"/>
              <circle cx="13" cy="14.5" r="1.5" fill="#231F20"/>
              <circle cx="17.5" cy="13" r="1.5" fill="#231F20"/>
              <circle cx="22" cy="14.5" r="1.5" fill="#231F20"/>
            </svg>
          </div>
          <div class="navbar-button-label">Themes</div>
        </button>
      </div>
      <div class="navbar-button-wrapper">
        <button style="background:#eab308" onclick="reloadPreview()">
          <div class="navbar-button-icon">
            <svg width="35" height="35" viewBox="0 0 35 35" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="17.5" cy="17.5" r="17.5" fill="#231F20"/>
              <path d="M24.5 17.5a7 7 0 01-12.6 4.2l-1.4 1.4A9 9 0 0026.5 17.5h-2z" fill="var(--vibes-cream)"/>
              <path d="M10.5 17.5a7 7 0 0112.6-4.2l1.4-1.4A9 9 0 008.5 17.5h2z" fill="var(--vibes-cream)"/>
              <path d="M24.5 17.5l2.5-2.5M24.5 17.5l2.5 2.5M10.5 17.5L8 15M10.5 17.5L8 20" stroke="var(--vibes-cream)" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="navbar-button-label" style="color:var(--vibes-near-black);text-shadow:none">Reload</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Split -->
  <div class="main">
    <!-- Preview -->
    <div class="preview-panel" id="previewPanel">
      <iframe class="preview-iframe" id="previewFrame" src="/app-frame"></iframe>
    </div>

    <!-- Splitter -->
    <div class="splitter" id="splitter"></div>

    <!-- Chat -->
    <div class="chat-panel" id="chatPanel">
      <div class="chat-messages" id="chatMessages">
        <div class="chat-bubble system">Connected to Vibes Live Preview. Send a message to iterate on your app, or click Themes to switch designs.</div>
      </div>
      <div class="chat-input-bar">
        <textarea class="chat-input" id="chatInput" placeholder="Describe changes to your app..." rows="1"
          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
        <button class="chat-send" id="sendBtn" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Theme Modal -->
  <div class="modal-overlay" id="themeModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Choose a Theme</h2>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <button class="modal-create-btn" id="createThemeToggle" onclick="toggleCreateMode()">+ Create</button>
          <button class="modal-close" onclick="closeThemeModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="createThemeSection" style="display:none;">
          <div class="create-theme-bar">
            <input type="text" class="create-theme-input" id="createThemePrompt"
              placeholder="Describe your theme (e.g. cyberpunk neon Tokyo)"
              onkeydown="if(event.key==='Enter'){generateThemeImages();}" />
            <button class="modal-create-btn" id="createThemeBtn" onclick="generateThemeImages()">Generate</button>
          </div>
          <div id="imagePickerArea"></div>
        </div>
        <input type="text" class="theme-search" id="themeSearch" placeholder="Search themes..." oninput="filterThemes(this.value)" />
        <div id="themeGrid">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // === State ===
    let ws = null;
    let isThinking = false;
    let themes = [];

    // === WebSocket ===
    function connectWs() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);

      ws.onopen = () => {
        console.log('[WS] Connected');
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === 'status') {
          if (msg.status === 'thinking') {
            setThinking(true, msg.progress, msg.stage, msg.elapsed);
          }
        } else if (msg.type === 'chat') {
          setThinking(false);
          addMessage(msg.role, msg.content);
        } else if (msg.type === 'app_updated') {
          setThinking(false);
          reloadPreview();
        } else if (msg.type === 'error') {
          setThinking(false);
          addMessage('error', msg.message);
        } else if (msg.type === 'cancelled') {
          setThinking(false);
          addMessage('system', 'Request cancelled.');
        } else if (msg.type === 'theme_images') {
          showThemeImages(msg.images);
        } else if (msg.type === 'theme_created') {
          onThemeCreated(msg.themeId, msg.themeName);
        }
      };

      ws.onclose = () => {
        console.log('[WS] Disconnected, reconnecting in 2s...');
        setTimeout(connectWs, 2000);
      };

      ws.onerror = (err) => {
        console.error('[WS] Error:', err);
      };
    }

    // === Chat ===
    function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || isThinking || !ws || ws.readyState !== WebSocket.OPEN) return;

      addMessage('user', text);
      ws.send(JSON.stringify({ type: 'chat', message: text }));
      input.value = '';
      input.style.height = 'auto';
    }

    function addMessage(role, content) {
      const container = document.getElementById('chatMessages');

      // Remove thinking indicator if present
      const indicator = container.querySelector('.thinking-indicator');
      if (indicator) indicator.remove();

      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${role}`;
      bubble.textContent = content;
      container.appendChild(bubble);
      container.scrollTop = container.scrollHeight;
    }

    function formatElapsed(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return m > 0 ? `${m}m ${s}s` : `${s}s`;
    }

    function cancelRequest() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'cancel' }));
      }
    }

    function setThinking(thinking, progress, stage, elapsed) {
      isThinking = thinking;
      const panel = document.getElementById('previewPanel');
      const sendBtn = document.getElementById('sendBtn');
      const container = document.getElementById('chatMessages');

      if (thinking) {
        panel.classList.add('thinking');
        sendBtn.disabled = true;

        let indicator = container.querySelector('.thinking-indicator');
        if (indicator) {
          const fill = indicator.querySelector('.thinking-progress-fill');
          const pct = indicator.querySelector('.thinking-pct');
          const stageEl = indicator.querySelector('.thinking-stage');
          const timerEl = indicator.querySelector('.thinking-timer');
          if (fill) fill.style.width = (progress || 0) + '%';
          if (pct) pct.textContent = (progress || 0) + '%';
          if (stageEl && stage) stageEl.textContent = stage;
          if (timerEl && elapsed != null) timerEl.textContent = formatElapsed(elapsed);
        } else {
          indicator = document.createElement('div');
          indicator.className = 'thinking-indicator';
          indicator.innerHTML = `
            <div class="thinking-header">
              <div class="thinking-dots">
                <div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div>
              </div>
              <span class="thinking-stage">${stage || 'Starting...'}</span>
            </div>
            <div class="thinking-progress-bar">
              <div class="thinking-progress-fill" style="width: ${progress || 0}%"></div>
            </div>
            <div class="thinking-footer">
              <span class="thinking-pct">${progress || 0}%</span>
              <span class="thinking-timer">${formatElapsed(elapsed || 0)}</span>
              <button class="thinking-cancel" onclick="cancelRequest()">Cancel</button>
            </div>`;
          container.appendChild(indicator);
        }
        container.scrollTop = container.scrollHeight;
      } else {
        panel.classList.remove('thinking');
        panel.classList.add('updated');
        setTimeout(() => panel.classList.remove('updated'), 600);
        sendBtn.disabled = false;

        const indicator = container.querySelector('.thinking-indicator');
        if (indicator) indicator.remove();
      }
    }

    // === Preview ===
    function reloadPreview() {
      const frame = document.getElementById('previewFrame');
      frame.src = '/app-frame?t=' + Date.now();

      // After iframe loads, activate the pending theme if any
      if (pendingThemeId) {
        const themeToSet = pendingThemeId;
        pendingThemeId = null;
        frame.onload = () => {
          try {
            const iframeDoc = frame.contentDocument || frame.contentWindow.document;
            frame.contentWindow.localStorage.setItem('vibes-theme', themeToSet);
            iframeDoc.dispatchEvent(new CustomEvent('vibes-design-request', { detail: { theme: themeToSet } }));
          } catch (e) {
            console.warn('[Preview] Could not dispatch theme event:', e);
          }
        };
      }
    }

    // === Themes ===
    async function loadThemes() {
      try {
        const res = await fetch('/themes');
        themes = await res.json();
        renderThemeGrid();
      } catch (err) {
        console.error('Failed to load themes:', err);
      }
    }

    function renderThemeGrid(filter) {
      const grid = document.getElementById('themeGrid');
      const q = (filter || '').toLowerCase().trim();

      const filtered = q
        ? themes.filter(t => `${t.name} ${t.mood} ${t.bestFor}`.toLowerCase().includes(q))
        : themes;

      const recommended = filtered.filter(t => t.recommended);
      const rest = filtered.filter(t => !t.recommended);

      function swatchHtml(colors) {
        if (!colors) return '';
        const bg = colors.bg || '#333';
        const text = colors.text || '#fff';
        const accent = colors.accent || '#888';
        const muted = colors.muted || '#666';
        return `<div class="theme-swatches">
          <div class="theme-swatch-bar">
            <div class="theme-swatch-segment" style="background:${bg};flex:3"></div>
            <div class="theme-swatch-segment" style="background:${text};flex:1"></div>
            <div class="theme-swatch-segment" style="background:${accent};flex:2"></div>
            <div class="theme-swatch-segment" style="background:${muted};flex:1"></div>
          </div>
        </div>`;
      }

      function cardHtml(t) {
        return `<div class="theme-card${t.recommended ? ' recommended' : ''}" onclick="selectTheme('${t.id}')">
          ${swatchHtml(t.colors)}
          <div class="theme-card-name">${t.name}${t.recommended ? '<span class="theme-card-badge">recommended</span>' : ''}</div>
          <div class="theme-card-mood">${t.mood}</div>
          <div class="theme-card-for">${t.bestFor}</div>
        </div>`;
      }

      let html = '';
      if (recommended.length > 0) {
        html += `<div class="theme-section-label">Recommended for your app</div>`;
        html += `<div class="theme-grid">${recommended.map(cardHtml).join('')}</div>`;
      }
      if (rest.length > 0) {
        html += `<div class="theme-section-label all">${recommended.length > 0 ? 'All themes' : 'Themes'}</div>`;
        html += `<div class="theme-grid">${rest.map(cardHtml).join('')}</div>`;
      }
      if (filtered.length === 0) {
        html = `<div style="text-align:center;color:#555;padding:2rem;">No themes match "${filter}"</div>`;
      }
      grid.innerHTML = html;
    }

    function filterThemes(value) {
      renderThemeGrid(value);
    }

    let pendingThemeId = null;

    function selectTheme(themeId) {
      if (isThinking || !ws || ws.readyState !== WebSocket.OPEN) return;

      const theme = themes.find(t => t.id === themeId);
      addMessage('user', `Switch to theme: ${theme ? theme.name : themeId}`);
      pendingThemeId = themeId;
      ws.send(JSON.stringify({ type: 'theme', themeId }));
      closeThemeModal();
    }

    function openThemeModal() {
      document.getElementById('themeModal').classList.add('open');
      const search = document.getElementById('themeSearch');
      search.value = '';
      renderThemeGrid();
      setTimeout(() => search.focus(), 100);
    }

    function closeThemeModal() {
      document.getElementById('themeModal').classList.remove('open');
    }

    // Close modal on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeThemeModal();
    });

    // Close modal on overlay click
    document.getElementById('themeModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeThemeModal();
    });

    // === Resizable Splitter ===
    (function() {
      const splitter = document.getElementById('splitter');
      const preview = document.getElementById('previewPanel');
      let isDragging = false;

      splitter.addEventListener('mousedown', (e) => {
        isDragging = true;
        splitter.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const mainRect = document.querySelector('.main').getBoundingClientRect();
        const pct = ((e.clientX - mainRect.left) / mainRect.width) * 100;
        const clamped = Math.max(30, Math.min(80, pct));
        preview.style.flex = `0 0 ${clamped}%`;
      });

      document.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        splitter.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      });
    })();

    // === Auto-resize textarea ===
    document.getElementById('chatInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // === Create Theme ===
    let createMode = false;
    let hasOpenRouterKey = false;

    async function checkOpenRouterKey() {
      try {
        const res = await fetch('/themes/has-key');
        const data = await res.json();
        hasOpenRouterKey = data.hasKey;
      } catch { /* ignore */ }
    }

    function toggleCreateMode() {
      createMode = !createMode;
      document.getElementById('createThemeSection').style.display = createMode ? '' : 'none';
      document.getElementById('themeSearch').style.display = createMode ? 'none' : '';
      document.getElementById('themeGrid').style.display = createMode ? 'none' : '';
      document.getElementById('createThemeToggle').textContent = createMode ? 'Browse' : '+ Create';
      if (createMode) {
        if (!hasOpenRouterKey) {
          document.getElementById('createThemeBtn').disabled = true;
          document.getElementById('createThemePrompt').disabled = true;
          document.getElementById('imagePickerArea').innerHTML =
            '<div class="create-status error">Add OPENROUTER_API_KEY to .env and restart the preview server to enable theme creation.</div>';
        } else {
          document.getElementById('createThemeBtn').disabled = false;
          document.getElementById('createThemePrompt').disabled = false;
          document.getElementById('createThemePrompt').focus();
          document.getElementById('imagePickerArea').innerHTML = '';
        }
      } else {
        renderThemeGrid();
      }
    }

    function generateThemeImages() {
      const input = document.getElementById('createThemePrompt');
      const prompt = input.value.trim();
      if (!prompt || !ws || ws.readyState !== WebSocket.OPEN) return;

      document.getElementById('createThemeBtn').disabled = true;
      document.getElementById('imagePickerArea').innerHTML =
        '<div class="image-picker">' +
        '<div class="image-card loading"><div class="spinner"></div></div>'.repeat(3) +
        '</div>' +
        '<div class="create-status">Generating 3 design variations...</div>';

      ws.send(JSON.stringify({ type: 'create_theme', prompt }));
    }

    function showThemeImages(images) {
      const area = document.getElementById('imagePickerArea');
      const picker = document.createElement('div');
      picker.className = 'image-picker';
      images.forEach((url, i) => {
        const card = document.createElement('div');
        card.className = 'image-card' + (url ? '' : ' failed');
        if (url) {
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'Variation ' + (i + 1);
          card.appendChild(img);
          card.onclick = () => pickThemeImage(i);
        } else {
          card.textContent = 'Failed';
          card.style.cssText = 'color:var(--vibes-red);font-size:0.75rem;font-weight:700;';
        }
        picker.appendChild(card);
      });
      area.innerHTML = '';
      area.appendChild(picker);
      const status = document.createElement('div');
      status.className = 'create-status';
      status.textContent = 'Click the design you like best';
      area.appendChild(status);
      document.getElementById('createThemeBtn').disabled = false;
    }

    function pickThemeImage(index) {
      const prompt = document.getElementById('createThemePrompt').value.trim();
      if (!ws || ws.readyState !== WebSocket.OPEN) return;

      const cards = document.querySelectorAll('.image-card');
      cards.forEach((c, i) => {
        c.style.opacity = i === index ? '1' : '0.3';
        c.style.pointerEvents = 'none';
      });

      const statusEl = document.getElementById('imagePickerArea').querySelector('.create-status');
      if (statusEl) {
        statusEl.innerHTML = '<div class="spinner" style="display:inline-block;width:16px;height:16px;vertical-align:middle;margin-right:0.5rem;"></div>Claude is analyzing the design and writing your theme...';
      }

      ws.send(JSON.stringify({ type: 'pick_theme_image', index, prompt }));
    }

    function onThemeCreated(themeId, themeName) {
      const area = document.getElementById('imagePickerArea');
      area.innerHTML = '';
      const status = document.createElement('div');
      status.className = 'create-status success';
      status.textContent = 'Theme "' + themeName + '" created!';
      area.appendChild(status);
      const btnRow = document.createElement('div');
      btnRow.style.cssText = 'text-align:center;margin-top:0.5rem;';
      const applyBtn = document.createElement('button');
      applyBtn.className = 'modal-create-btn';
      applyBtn.textContent = 'Apply ' + themeName;
      applyBtn.onclick = () => selectTheme(themeId);
      const browseBtn = document.createElement('button');
      browseBtn.className = 'modal-create-btn';
      browseBtn.style.marginLeft = '0.5rem';
      browseBtn.textContent = 'Browse themes';
      browseBtn.onclick = () => toggleCreateMode();
      btnRow.appendChild(applyBtn);
      btnRow.appendChild(browseBtn);
      area.appendChild(btnRow);
      document.getElementById('createThemeBtn').disabled = false;
      loadThemes();
    }

    // === Init ===
    connectWs();
    loadThemes();
    checkOpenRouterKey();
  </script>
</div>
</div>
</body>
</html>
