<script type="text/babel" data-type="module">
      import ReactDOMClient from "react-dom/client";

      // __VIBES_APP_CODE__

      // Use shared error components from base template
      const ConfigError = window.ConfigError;
      const LoadingError = window.LoadingError;

      // App wrapper with Clerk auth gate (always required)
      function AppWrapper() {
        const config = window.__VIBES_CONFIG__;

        // Hook must be called unconditionally at top of component (Rules of Hooks)
        window.useVibesPanelEvents('Vibes');

        // Check for configuration errors
        if (!config?.clerkPublishableKey || config.clerkPublishableKey.startsWith('__')) {
          return <ConfigError message="Missing Clerk publishable key. Apps require authentication." />;
        }

        // Check if Clerk components loaded
        if (!window.ClerkFireproofProvider) {
          return <LoadingError error={window.__CLERK_LOAD_ERROR__ || 'Clerk components not available'} />;
        }

        const { ClerkFireproofProvider, SignedIn, SignedOut, SignInButton } = window.ClerkComponents;

        // AuthGate shown when user is not signed in
        const AuthGate = () => (
          <div className="min-h-screen flex items-center justify-center bg-gray-50">
            <div className="text-center p-8 bg-white rounded-xl shadow-lg max-w-md">
              <h1 className="text-2xl font-bold mb-4">Sign in to continue</h1>
              <p className="text-gray-600 mb-6">This app uses cloud sync and requires authentication.</p>
              <SignInButton mode="modal">
                <button className="px-6 py-3 bg-black text-white rounded-lg font-medium hover:bg-gray-800 transition-colors">
                  Sign In
                </button>
              </SignInButton>
            </div>
          </div>
        );

        return (
          <ClerkFireproofProvider
            publishableKey={config.clerkPublishableKey}
            config={{
              apiUrl: config.tokenApiUri,
              cloudUrl: config.cloudBackendUrl
            }}
          >
            <SignedOut>
              <AuthGate />
            </SignedOut>
            <SignedIn>
              <HiddenMenuWrapper menuContent={<VibesPanel />}>
                <App />
              </HiddenMenuWrapper>
            </SignedIn>
          </ClerkFireproofProvider>
        );
      }

      // Load Clerk components (required for all apps)
      async function initApp() {
        try {
          // Dynamic import of @fireproof/clerk package
          const clerkModule = await import("@fireproof/clerk");
          window.ClerkFireproofProvider = clerkModule.ClerkFireproofProvider;
          window.ClerkComponents = {
            ClerkFireproofProvider: clerkModule.ClerkFireproofProvider,
            SignedIn: clerkModule.SignedIn,
            SignedOut: clerkModule.SignedOut,
            SignInButton: clerkModule.SignInButton,
            UserButton: clerkModule.UserButton
          };
          // Export for user's App code
          window.SignedIn = clerkModule.SignedIn;
          window.SignedOut = clerkModule.SignedOut;
          window.SignInButton = clerkModule.SignInButton;
          window.UserButton = clerkModule.UserButton;
          // Export Fireproof hook for user's App code
          window.useFireproofClerk = clerkModule.useFireproofClerk;
        } catch (err) {
          console.error('Failed to load Clerk components:', err);
          window.__CLERK_LOAD_ERROR__ = err.message || String(err);
        }

        const rootElement = document.getElementById("container");
        ReactDOMClient.createRoot(rootElement).render(<AppWrapper />);
      }

      initApp();
    </script>
