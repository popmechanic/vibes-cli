<script type="text/babel" data-type="module">
      import ReactDOMClient from "react-dom/client";

      // __VIBES_APP_CODE__

      // Use shared error components from base template
      const ConfigError = window.ConfigError;
      const LoadingError = window.LoadingError;

      // App wrapper with Clerk auth gate (always required)
      function AppWrapper() {
        const config = window.__VIBES_CONFIG__;

        // Hook must be called unconditionally at top of component (Rules of Hooks)
        window.useVibesPanelEvents('Vibes');

        // Check for configuration errors
        if (!config?.clerkPublishableKey || config.clerkPublishableKey.startsWith('__')) {
          return <ConfigError message="Missing Clerk publishable key. Apps require authentication." />;
        }

        // Check if Clerk components loaded
        if (!window.ClerkFireproofProvider) {
          return <LoadingError error={window.__CLERK_LOAD_ERROR__ || 'Clerk components not available'} />;
        }

        const { ClerkFireproofProvider, SignedIn, SignedOut, SignInButton } = window.ClerkComponents;

        // Use shared components from window
        const AuthScreen = window.AuthScreen;
        const VibesButton = window.VibesButton;
        const RED = window.RED;

        // AuthGate shown when user is not signed in
        const AuthGate = () => (
          <AuthScreen
            title="Sign in to continue"
            message="This app uses cloud sync and requires authentication."
            showCard={true}
          >
            <SignInButton mode="modal">
              <VibesButton variant={RED} buttonType="form">
                Sign In
              </VibesButton>
            </SignInButton>
          </AuthScreen>
        );

        return (
          <>
            <SyncStatusDot />
            <ClerkFireproofProvider
              publishableKey={config.clerkPublishableKey}
              config={{
                apiUrl: config.tokenApiUri,
                cloudUrl: config.cloudBackendUrl
              }}
            >
              <SignedOut>
                <AuthGate />
              </SignedOut>
              <SignedIn>
                <HiddenMenuWrapper menuContent={<VibesPanel />}>
                  <App />
                </HiddenMenuWrapper>
              </SignedIn>
            </ClerkFireproofProvider>
          </>
        );
      }

      // Load Clerk components (required for all apps)
      async function initApp() {
        try {
          // Dynamic import of @fireproof/clerk package
          const clerkModule = await import("@fireproof/clerk");
          window.ClerkFireproofProvider = clerkModule.ClerkFireproofProvider;
          window.ClerkComponents = {
            ClerkFireproofProvider: clerkModule.ClerkFireproofProvider,
            SignedIn: clerkModule.SignedIn,
            SignedOut: clerkModule.SignedOut,
            SignInButton: clerkModule.SignInButton,
            UserButton: clerkModule.UserButton
          };
          // Export for user's App code
          window.SignedIn = clerkModule.SignedIn;
          window.SignedOut = clerkModule.SignedOut;
          window.SignInButton = clerkModule.SignInButton;
          window.UserButton = clerkModule.UserButton;
          // Export Fireproof hook for user's App code, with sync status bridge
          var _originalUseFireproofClerk = clerkModule.useFireproofClerk;
          window.useFireproofClerk = function(name, opts) {
            var result = _originalUseFireproofClerk(name, opts);
            var syncVal = result.syncStatus || 'idle';
            React.useEffect(function() {
              if (window.__VIBES_SYNC_STATUS__ !== syncVal) {
                window.__VIBES_SYNC_STATUS__ = syncVal;
                window.dispatchEvent(new CustomEvent('vibes-sync-status-change'));
              }
            }, [syncVal]);
            // Workaround: Fireproof's fast-forward path sets clock.head without
            // firing onTock. Poll allDocs and kick notifications when data appears.
            React.useEffect(function() {
              console.log('[vibes] onTock kick effect, syncVal:', syncVal);
              if (syncVal !== 'synced') return;
              var db = result.database;
              var kicked = false;
              var poll = function() {
                if (kicked) return;
                db.allDocs().then(function(res) {
                  if (kicked) return;
                  if (res.rows.length > 0) {
                    kicked = true;
                    try {
                      db.ledger.crdt.clock.noPayloadWatchers.forEach(function(fn) { fn(); });
                      console.log('[vibes] Kicked onTock after detecting', res.rows.length, 'docs');
                    } catch (e) {
                      console.log('[vibes] onTock kick failed:', e);
                    }
                  } else if (!kicked) {
                    setTimeout(poll, 2000);
                  }
                }).catch(function() {
                  if (!kicked) setTimeout(poll, 2000);
                });
              };
              var start = setTimeout(poll, 2000);
              var max = setTimeout(function() { kicked = true; }, 20000);
              return function() { kicked = true; clearTimeout(start); clearTimeout(max); };
            }, [syncVal, result.database]);
            return result;
          };
        } catch (err) {
          console.error('Failed to load Clerk components:', err);
          window.__CLERK_LOAD_ERROR__ = err.message || String(err);
        }

        const rootElement = document.getElementById("container");
        ReactDOMClient.createRoot(rootElement).render(<AppWrapper />);
      }

      initApp();
    </script>
