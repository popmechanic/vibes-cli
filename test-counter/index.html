<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Counter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vibes Design System - synced from vibes.diy -->
  <link rel="stylesheet" href="../cache/vibes-variables.css">
  <style>
    /* Menu keyframes animation */
    @keyframes vibes-drop-to-close {
      0%   { transform: translateY(-400px); }
      10%  { transform: translateY(0); }
      25%  { transform: translateY(-175px); }
      35%  { transform: translateY(0); }
      48%  { transform: translateY(-75px); }
      62%  { transform: translateY(0); }
      72%  { transform: translateY(-25px); }
      80%  { transform: translateY(0); }
      82%  { transform: translateY(-10px); }
      88%  { transform: translateY(0); }
      91%  { transform: translateY(-5px); }
      95%  { transform: translateY(0); }
      100% { transform: translateY(0); }
    }
  </style>
  <script type="importmap">
  {
        "imports": {
              "react": "https://esm.sh/react",
              "react-dom": "https://esm.sh/react-dom",
              "react-dom/client": "https://esm.sh/react-dom/client",
              "react/jsx-runtime": "https://esm.sh/react/jsx-runtime",
              "use-fireproof": "https://esm.sh/use-vibes@0.18.9?external=react,react-dom",
              "call-ai": "https://esm.sh/call-ai@0.18.9?external=react,react-dom",
              "use-vibes": "https://esm.sh/use-vibes@0.18.9?external=react,react-dom"
        }
  }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import React from "react";
    import ReactDOM from "react-dom/client";
    import { useFireproof } from "use-fireproof";

    // Make React available globally for synced components
    window.React = React;

    // Fetch and execute the synced vibes-menu.js
    const response = await fetch("../cache/vibes-menu.js");
    const code = await response.text();
    eval(code);

    const e = React.createElement;

    // === HIDDEN MENU WRAPPER (using synced theme/styles) ===
    const hiddenMenuTheme = {
      colors: {
        menuBg: "var(--vibes-gray-lightest, #d4d4d4)",
        menuText: "var(--vibes-white, #ffffff)",
        contentBg: "#1e1e1e",
        shadow: "rgba(0, 0, 0, 0.3)",
        gridLineColor: "rgba(255, 255, 255, 0.5)"
      },
      zIndex: { menu: 5, content: 10, toggle: 20 },
      dimensions: { gridSize: "40px", padding: "24px", bottomOffset: "16px" },
      animation: { duration: "0.4s", easing: "ease", blurAmount: "4px" }
    };

    function StandaloneMenuWrapper({ children, menuContent, showVibesSwitch = true }) {
      const [menuOpen, setMenuOpen] = React.useState(false);
      const [menuHeight, setMenuHeight] = React.useState(0);
      const [isBouncing, setIsBouncing] = React.useState(false);
      const [hasBouncedOnMount, setHasBouncedOnMount] = React.useState(false);
      const menuRef = React.useRef(null);
      const buttonRef = React.useRef(null);

      React.useEffect(() => {
        if (!hasBouncedOnMount && !menuOpen) {
          const prefersReducedMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches || false;
          if (!prefersReducedMotion) {
            setIsBouncing(true);
            setTimeout(() => setIsBouncing(false), 800);
          }
          setHasBouncedOnMount(true);
        }
      }, [hasBouncedOnMount, menuOpen]);

      React.useLayoutEffect(() => {
        if (menuRef.current) {
          const next = menuRef.current.offsetHeight;
          setMenuHeight(prev => prev !== next ? next : prev);
        }
      }, [menuContent, menuOpen]);

      React.useEffect(() => {
        const handleKeyDown = (ev) => {
          if (ev.key === "Escape" && menuOpen) {
            setMenuOpen(false);
            buttonRef.current?.focus();
          }
        };
        document.addEventListener("keydown", handleKeyDown);
        return () => document.removeEventListener("keydown", handleKeyDown);
      }, [menuOpen]);

      const wrapperStyle = { position: "relative", overflow: "hidden" };
      const menuStyle = {
        position: "fixed",
        bottom: 0, left: 0, right: 0,
        zIndex: hiddenMenuTheme.zIndex.menu,
        color: hiddenMenuTheme.colors.menuText,
        padding: hiddenMenuTheme.dimensions.padding,
        boxShadow: `0 -2px 10px ${hiddenMenuTheme.colors.shadow}`,
        backgroundColor: hiddenMenuTheme.colors.menuBg,
        backgroundImage: `linear-gradient(${hiddenMenuTheme.colors.gridLineColor} 1px, transparent 1px), linear-gradient(90deg, ${hiddenMenuTheme.colors.gridLineColor} 1px, transparent 1px)`,
        backgroundSize: `${hiddenMenuTheme.dimensions.gridSize} ${hiddenMenuTheme.dimensions.gridSize}`
      };
      const contentWrapperStyle = {
        position: "fixed",
        top: 0, left: 0, right: 0, bottom: 0,
        zIndex: hiddenMenuTheme.zIndex.content,
        transition: isBouncing ? `filter 0.3s ${hiddenMenuTheme.animation.easing}` : `transform ${hiddenMenuTheme.animation.duration} ${hiddenMenuTheme.animation.easing}, filter 0.3s ${hiddenMenuTheme.animation.easing}`,
        transform: menuOpen ? `translateY(-${menuHeight}px)` : "translateY(0)",
        overflowY: "auto",
        borderTopColor: hiddenMenuTheme.colors.menuBg,
        borderTopWidth: "1px",
        borderTopStyle: "solid",
        boxShadow: `0 -2px 10px ${hiddenMenuTheme.colors.shadow}`,
        backgroundColor: hiddenMenuTheme.colors.contentBg,
        animation: isBouncing ? "vibes-drop-to-close 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)" : undefined,
        willChange: isBouncing ? "transform" : undefined
      };
      const innerContentStyle = { filter: menuOpen ? `blur(${hiddenMenuTheme.animation.blurAmount})` : "none", width: "100%", height: "100%" };
      const toggleButtonStyle = { position: "fixed", bottom: hiddenMenuTheme.dimensions.bottomOffset, right: 0, zIndex: hiddenMenuTheme.zIndex.toggle, backgroundColor: "transparent", border: "none", cursor: "pointer" };

      return e("div", { style: wrapperStyle },
        e("div", { id: "hidden-menu", role: "dialog", "aria-modal": "true", "aria-label": "Hidden menu", "aria-hidden": !menuOpen, ref: menuRef, style: menuStyle }, menuContent),
        e("div", { style: contentWrapperStyle }, e("div", { style: innerContentStyle }, e("div", { style: { width: "100%", height: "100%" } }, children))),
        showVibesSwitch && e("button", { "aria-haspopup": "dialog", "aria-expanded": menuOpen, "aria-controls": "hidden-menu", ref: buttonRef, onClick: () => setMenuOpen(!menuOpen), style: toggleButtonStyle }, e(window.VibesSwitch, { size: 80 }))
      );
    }

    // === VIBES PANEL (using synced VibesButton with icons) ===
    function VibesPanel({ dbName }) {
      const handleClearData = async () => {
        if (confirm("Clear all data? This cannot be undone.")) {
          const databases = await indexedDB.databases();
          for (const db of databases) {
            if (db.name && db.name.includes(dbName)) {
              indexedDB.deleteDatabase(db.name);
            }
          }
          window.location.reload();
        }
      };

      // Use synced VibesButton - it uses the synced CSS variables and icon components
      const buttonWidth = { width: "200px" };
      return e("div", { style: { display: "flex", flexDirection: "column", justifyContent: "center", alignItems: "center", gap: "16px", padding: "24px" } },
        e(window.VibesButton, { variant: "blue", icon: "remix", onClick: () => alert("Remix feature - customize this app!"), style: buttonWidth }, "REMIX"),
        e(window.VibesButton, { variant: "red", onClick: handleClearData, style: buttonWidth }, "CLEAR DATA"),
        e(window.VibesButton, { variant: "yellow", onClick: () => window.open("https://vibes.diy", "_blank"), style: buttonWidth }, "VIBES.DIY")
      );
    }

    // === APP COMPONENT ===
    function App() {
      const { useLiveQuery, database } = useFireproof("counter-db");
      const { docs } = useLiveQuery("_id", { key: "counter" });
      const count = docs[0]?.value || 0;

      const increment = async () => {
        await database.put({ _id: "counter", value: count + 1 });
      };
      const decrement = async () => {
        await database.put({ _id: "counter", value: count - 1 });
      };

      return e("div", { className: "min-h-screen bg-[#f1f5f9] flex items-center justify-center p-4" },
        e("div", { className: "bg-white border-4 border-[#0f172a] shadow-[6px_6px_0px_#0f172a] p-8 text-center" },
          e("h1", { className: "text-3xl font-bold text-[#0f172a] mb-6" }, "Simple Counter"),
          e("div", { className: "text-6xl font-bold text-[#0f172a] mb-8 font-mono" }, count),
          e("div", { className: "flex gap-4 justify-center" },
            e("button", { onClick: decrement, className: "px-8 py-4 bg-[#f1f5f9] border-4 border-[#0f172a] shadow-[4px_4px_0px_#0f172a] hover:shadow-[2px_2px_0px_#0f172a] active:shadow-none font-bold text-2xl text-[#0f172a] transition-all" }, "-"),
            e("button", { onClick: increment, className: "px-8 py-4 bg-[#f1f5f9] border-4 border-[#0f172a] shadow-[4px_4px_0px_#0f172a] hover:shadow-[2px_2px_0px_#0f172a] active:shadow-none font-bold text-2xl text-[#0f172a] transition-all" }, "+")
          ),
          e("p", { className: "mt-6 text-[#64748b] text-sm" }, "Count persists to Fireproof database")
        )
      );
    }

    const dbName = "counter-db";
    ReactDOM.createRoot(document.getElementById("root")).render(
      e(StandaloneMenuWrapper, { menuContent: e(VibesPanel, { dbName }) }, e(App))
    );
  </script>
</body>
</html>
