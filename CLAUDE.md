# Vibes DIY Plugin - Development Guide

## Agent Quick Reference

**This section helps coding agents navigate this codebase efficiently.**

### When to Read What

| Task | Read First |
|------|------------|
| Working on skills | The specific `skills/*/SKILL.md` file |
| Generating app code | SKILL.md has patterns; for advanced features, read `cache/fireproof.txt` |
| Working on scripts | `scripts/package.json` for deps, this file for architecture |
| Debugging React errors | "Known Issues" section below |

### Fireproof API Reference

SKILL.md provides common patterns (useDocument, useLiveQuery, database.put/del) and critical gotchas.

**Read `cache/fireproof.txt` when the user's app needs:**

| Feature | Signal in prompt | fireproof.txt section |
|---------|------------------|----------------------|
| User authentication | "login", "auth", "accounts", "Clerk" | Quick Start, API Reference |
| Sync status indicators | "connection status", "online/offline" | Sync Status Display |
| User context/identity | "user name", "profile", "who is logged in" | User Context, useUser() |
| Complete example | "full example", "show me how" | Complete Example |
| Migration from use-fireproof | "migrate", "update existing" | Differences from Standard Fireproof |

### ClerkFireproofProvider Config Pattern

Working configuration pattern for Vite apps with Clerk authentication:

```tsx
import { ClerkFireproofProvider } from "@necrodome/fireproof-clerk";

const config = {
  apiUrl: import.meta.env.VITE_API_URL || "http://localhost:8080/api/",
  cloudUrl: import.meta.env.VITE_CLOUD_URL || "fpcloud://localhost:8080?protocol=ws",
};

<ClerkFireproofProvider publishableKey={CLERK_KEY} config={config}>
  {/* app content */}
</ClerkFireproofProvider>
```

**Environment Variables:**

| Variable | Purpose | Production Example |
|----------|---------|-------------------|
| `VITE_CLERK_PUBLISHABLE_KEY` | Clerk auth | `pk_test_...` or `pk_live_...` |
| `VITE_API_URL` | Token API endpoint | `https://yourvm.exe.xyz/api` |
| `VITE_CLOUD_URL` | Cloud sync (fpcloud protocol) | `fpcloud://yourvm.exe.xyz/backend?protocol=wss` |

### Architecture at a Glance

```
User invokes skill (e.g., /vibes:vibes)
       │
       ▼
skills/*.SKILL.md loaded into context
       │
       ▼
Agent generates app.jsx
       │
       ▼
scripts/assemble.js (inserts JSX into template)
       │
       ▼
index.html (ready to deploy)
```

### Template Inheritance Architecture

Templates use a DRY inheritance pattern:

```
components/             → build-components.js → cache/vibes-menu.js
                                                       ↓
skills/_base/template.html  ←── shared code (components, CSS, imports)
         +
skills/vibes/template.delta.html  ←── vibes-specific code
skills/sell/template.delta.html   ←── sell-specific code (multi-tenant routing)
skills/riff/template.delta.html   ←── riff-specific code
         ↓
    merge-templates.js
         ↓
skills/*/templates/index.html  ←── final assembled templates
```

Build workflow:
```bash
node scripts/build-components.js --force  # Build components from local source
node scripts/merge-templates.js --force   # Merge base + deltas into final templates
```

### File Intent Guide

| File Pattern | Intent |
|--------------|--------|
| `skills/*/SKILL.md` | Loaded verbatim into Claude. Edit carefully - affects agent behavior |
| `skills/_base/template.html` | Base template with shared code. Edit for all skills. |
| `skills/*/template.delta.html` | Skill-specific code. Only unique functionality. |
| `skills/*/templates/*.html` | Generated templates. Don't edit - regenerated by merge-templates.js |
| `components/` | Local TypeScript components. Built by build-components.js |
| `scripts/*.js` | Node.js tools. Run locally, not loaded into Claude |
| `cache/*` | Working cache (gitignored). Source of truth for versions |
| `skills/*/cache/*` | Default cache (git-tracked). Stable fallback |

---

## Core Design Principle

**Match vibes.diy exactly. Never deviate.**

This plugin generates React apps that are compatible with the vibes.diy ecosystem. All configuration—import maps, package versions, style prompts—MUST come from the upstream vibes.diy repository. Do not "improve" or "optimize" by changing values.

## Architecture: The Sync Pattern

### Data Flow

```
vibes.diy repo (GitHub)
        │
        │ fetch (HTTP)
        ▼
  /cache/ directory
   ├── import-map.json    ← Package versions
   ├── style-prompt.txt   ← UI style guide
   └── fireproof.txt      ← API documentation
        │
        │ regex replacement
        ▼
  Template files updated
   └── skills/vibes/SKILL.md
```

### How Sync Works

The `scripts/sync.js` script (Node.js + esbuild):

1. **Fetches** from vibes.diy GitHub raw URLs
2. **Parses** TypeScript source to extract values (handles both quoted and unquoted keys)
3. **Caches** parsed data in `/cache/` as JSON/text
4. **Updates** template files by regex-replacing `<script type="importmap">` blocks

Run sync with: `/vibes:sync` or `node scripts/sync.js --force`

**Prerequisites:** Node.js 18+ (uses native fetch). Install deps: `cd scripts && npm install`

### What Gets Synced

| Source | Cache File | Updates |
|--------|------------|---------|
| `import-map.ts` | `cache/import-map.json` | Import maps in SKILL.md |
| `style-prompts.ts` | `cache/style-prompt.txt` | UI style guidance |
| `css-variables.ts` | `cache/vibes-variables.css` | CSS theme variables |

**Note:** Menu components (VibesSwitch, VibesPanel, etc.) are now built from local `components/` directory, not synced from upstream. Run `node scripts/build-components.js` to rebuild.

**Note on Versions:** This plugin uses `esm.sh/stable/` URLs with `@necrodome/fireproof-clerk@0.0.3` and React 19.2.4. The `/stable/` path provides pre-built, cached packages that avoid dependency resolution issues. The git-tracked `skills/vibes/cache/` contains the current versions and serves as the authoritative source.

### Configuring Upstream Sources

The sync script supports custom upstream URLs via config file or environment variables.

**Priority:** Environment variables > `config/sources.json` > defaults

**Config file:** Copy `config/sources.example.json` to `config/sources.json` and modify URLs.

**Environment variables:**
- `VIBES_FIREPROOF_URL` - Fireproof documentation URL
- `VIBES_STYLE_PROMPT_URL` - Style prompts source
- `VIBES_IMPORT_MAP_URL` - Import map source
- `VIBES_CSS_VARIABLES_URL` - CSS variables source

Example:
```bash
VIBES_IMPORT_MAP_URL="https://example.com/my-import-map.ts" node scripts/sync.js --force
```

## Critical Rules

### 1. NEVER Hardcode Import Map Values

Let the sync script update templates from cache:

```bash
node scripts/sync.js --force
```

### 2. Use `?external=` for React Singleton

When using `@necrodome/fireproof-clerk` via esm.sh, you MUST add `?external=react,react-dom` to ensure a single React instance:

```json
"@fireproof/clerk": "https://esm.sh/stable/@necrodome/fireproof-clerk@0.0.3?external=react,react-dom"
```

**Why `?external=`:** This tells esm.sh to keep `react` and `react-dom` as bare specifiers instead of bundling them. The browser's import map then intercepts these bare specifiers, ensuring all code uses the same React instance.

**Why NOT `?alias=`:** The `?alias` parameter rewrites imports at esm.sh build time, but doesn't prevent esm.sh from resolving its own React version for internal dependencies. `?external` is more reliable for no-build workflows.

### 3. Include ALL Import Entries

The import map requires these entries:

```json
{
  "react": "https://esm.sh/stable/react@19.2.4",
  "react/jsx-runtime": "https://esm.sh/stable/react@19.2.4/jsx-runtime",
  "react/jsx-dev-runtime": "https://esm.sh/stable/react@19.2.4/jsx-dev-runtime",
  "react-dom": "https://esm.sh/stable/react-dom@19.2.4",
  "react-dom/client": "https://esm.sh/stable/react-dom@19.2.4/client",
  "use-fireproof": "https://esm.sh/stable/@necrodome/fireproof-clerk@0.0.3?external=react,react-dom",
  "@fireproof/clerk": "https://esm.sh/stable/@necrodome/fireproof-clerk@0.0.3?external=react,react-dom"
}
```

**Notes:**
- The `/stable/` path uses pre-built, cached versions from esm.sh that avoid on-the-fly dependency resolution issues
- `?external=react,react-dom` is REQUIRED to prevent duplicate React instances
- Uses `@necrodome/fireproof-clerk@0.0.3` for Clerk auth integration

### 4. NEVER Update Documentation Examples Manually

Import map examples in documentation become stale. Reference `cache/import-map.json` instead of embedding versions.

## Common Mistakes

| Mistake | Consequence | Fix |
|---------|-------------|-----|
| Missing `?external=react,react-dom` on fireproof-clerk URLs | Multiple React instances, context errors | Add `?external=react,react-dom` to fireproof-clerk imports |
| Not using `esm.sh/stable/` path | Dependency resolution issues | Use `/stable/` prefix for pre-built packages |
| Missing `react/jsx-runtime` | Build errors | Run sync to get all entries |
| Hardcoded versions in docs | Docs become stale | Reference cache file |
| Editing templates without running sync | Versions out of date | Always run sync after edits |

## Local Development

To test the plugin from local source (instead of the installed version):

```bash
# From the plugin directory
claude --plugin .

# Or with absolute path
claude --plugin /path/to/vibes-skill
```

This loads skills and commands from your local checkout, so you can test changes without publishing.

## Testing

The plugin includes a comprehensive test suite using Vitest. Tests are organized into three tiers:

### Running Tests

```bash
cd scripts

# Install dependencies (first time)
npm install

# Run all tests
npm test

# Run only unit tests (fastest, <1 second)
npm run test:unit

# Run integration tests (mocked external services)
npm run test:integration

# Start E2E local server for manual testing
npm run test:e2e:server
```

### Test Structure

```
scripts/__tests__/
├── unit/                    # Pure logic, no I/O
│   ├── config-parsing.test.js
│   ├── webhook-signature.test.js
│   ├── jwt-validation.test.js    # azp matching, timing validation
│   └── auth-flows.test.js        # State machine transitions
├── e2e/                     # Local server for manual testing
│   └── local-server.js
└── mocks/                   # Shared test doubles
    └── clerk-webhooks.js
```

### E2E Testing with /etc/hosts

For full subdomain routing tests without real DNS:

1. Add to `/etc/hosts`:
```
127.0.0.1  test-app.local
127.0.0.1  tenant1.test-app.local
127.0.0.1  admin.test-app.local
```

2. Start the local server:
```bash
npm run test:e2e:server
```

3. Open in browser:
   - `http://test-app.local:3000` - Landing page
   - `http://tenant1.test-app.local:3000` - Tenant app
   - `http://admin.test-app.local:3000` - Admin dashboard

### Verify Sync Worked

```bash
# Check cache was updated (should show 9 entries)
cat cache/import-map.json | jq '.imports | keys | length'

# Check templates were updated (should show 4 occurrences)
grep -c "esm.sh/use-vibes" skills/vibes/SKILL.md
```

### Test Generated Apps

1. Generate a simple app with `/vibes:vibes`
2. Open `index.html` in your browser
3. Check console for errors:
   - No "Fireproof is not defined" errors
   - No infinite loops or page lockups

### Adding New Tests

- **Unit tests** go in `scripts/__tests__/unit/` - for pure functions with no I/O
- **Integration tests** go in `scripts/__tests__/integration/` - use mocks from `mocks/`
- **Mocks** go in `scripts/__tests__/mocks/` - shared test doubles for external services

## File Reference

| File | Purpose |
|------|---------|
| `scripts/assemble.js` | Assembly script - inserts JSX into template |
| `scripts/assemble-sell.js` | SaaS assembly script - generates multi-tenant app |
| `scripts/sync.js` | Sync script - fetches style prompts, import maps, CSS variables |
| `scripts/build-components.js` | Build components from local `components/` directory |
| `scripts/merge-templates.js` | Merge base + delta templates into final templates |
| `scripts/find-plugin.js` | Plugin directory lookup with validation |
| `scripts/update.js` | Deterministic app updater |
| `scripts/deploy-exe.js` | App deployment to exe.dev (static files, AI proxy, registry) |
| `scripts/deploy-connect.js` | Connect Studio deployment to exe.dev (Docker-based sync) |
| `scripts/generate-riff.js` | Parallel riff generator - spawns claude -p for variations |
| `scripts/assemble-all.js` | Batch assembler for riff directories |
| `scripts/lib/exe-ssh.js` | SSH automation for exe.dev |
| `scripts/package.json` | Node.js deps |
| `config/sources.example.json` | Example config for upstream URL overrides |
| `components/` | Local TypeScript components (VibesSwitch, VibesPanel, etc.) |
| `cache/import-map.json` | Working cache - package versions |
| `cache/style-prompt.txt` | Working cache - UI style guidance |
| `cache/fireproof.txt` | Working cache - Fireproof API docs |
| `cache/vibes-menu.js` | Built components from local source |
| `cache/vibes-variables.css` | Working cache - CSS theme variables |
| `skills/_base/template.html` | Base template with shared code (components, CSS, imports) |
| `skills/vibes/template.delta.html` | Vibes-specific delta (Clerk auth wrapper) |
| `skills/vibes/templates/index.html` | Generated vibes template |
| `skills/vibes/SKILL.md` | Main vibes skill (has import map) |
| `skills/vibes/cache/` | Default cache (git-tracked) - ships with plugin |
| `skills/riff/template.delta.html` | Riff-specific delta |
| `skills/riff/templates/index.html` | Generated riff template |
| `skills/riff/SKILL.md` | Riff skill for parallel app generation |
| `skills/sell/template.delta.html` | Sell-specific delta (multi-tenant routing) |
| `skills/sell/templates/unified.html` | Generated SaaS template |
| `skills/sell/SKILL.md` | Sell skill for SaaS transformation |
| `skills/design-reference/SKILL.md` | Design reference skill - mechanical HTML→React transformation |
| `scripts/registry-server.ts` | Bun server for subdomain registry + Clerk webhooks |
| `scripts/lib/jwt-validation.js` | JWT validation utilities (azp matching, timing) |
| `scripts/lib/auth-flows.js` | Auth flow state machines (signup, signin, gate) |
| `skills/exe/SKILL.md` | exe.dev app deployment skill |
| `skills/connect/SKILL.md` | Connect Studio deployment skill |
| `commands/sync.md` | User-facing sync command definition |
| `commands/update.md` | User-facing update command definition |

### Cache Locations

There are two cache locations by design:

1. **`/cache/`** (gitignored) - Working cache
   - `import-map.json` - Package versions and CDN URLs (from sync.js)
   - `style-prompt.txt` - UI style guidance (from sync.js)
   - `fireproof.txt` - Fireproof API documentation
   - `vibes-menu.js` - Built components (from build-components.js)
   - `vibes-variables.css` - CSS theme variables (from sync.js)

2. **`skills/vibes/cache/`** (git-tracked) - Default values shipped with the plugin
   - Uses `esm.sh/stable/` URLs with `?external=react,react-dom`
   - Serves as fallback for users who haven't run sync yet
   - **This is the authoritative source for current versions**

**Build scripts:**
- `sync.js` - Updates import-map.json, style-prompt.txt, vibes-variables.css from upstream
- `build-components.js` - Builds vibes-menu.js from local `components/` directory
- `merge-templates.js` - Combines base + delta templates into final templates

**When to read cache files:**
- `fireproof.txt` - Contains `@fireproof/clerk` docs for authenticated sync. Read when Connect is set up and apps need Clerk auth patterns.
- `style-prompt.txt` - Read when you need UI/color guidance beyond what's in SKILL.md
- `import-map.json` - Reference only; never hardcode these values

## Architecture: JSX + Babel

The plugin now uses **JSX with Babel transpilation** (matching vibes.diy exactly):

1. **Model outputs JSX** - Standard React syntax, faster to generate
2. **Babel transpiles at runtime** - `<script type="text/babel">` in template
3. **Assembly script** - `node scripts/assemble.js app.jsx index.html`

This architecture matches vibes.diy and significantly improves generation speed.

## The React Singleton Problem

### Understanding the Architecture

vibes.diy uses import maps - a browser-native feature (since March 2023) that maps bare specifiers like `"react"` to CDN URLs.

### The Core Problem

**Import maps can only intercept bare specifiers**, not absolute URL paths:

| Import Type | Example | Import Map Intercepts? |
|-------------|---------|------------------------|
| Bare specifier | `import "react"` | ✅ Yes |
| Absolute path | `import "/react@19.2.1"` | ❌ No |

When esm.sh bundles `use-vibes`, internal React imports become absolute paths:
```javascript
import "/react@>=19.1.0?target=es2022";  // Resolved relative to esm.sh origin
```

**Result**: Our import map provides React 19.2.1, but use-vibes loads React 19.2.3 → TWO React instances → context fails.

### The Solution: `?external=`

From Preact's no-build workflow guide and esm.sh documentation:

> "By using `?external=preact`, we tell esm.sh that it shouldn't provide a copy of preact... the browser will use our importmap to resolve `preact`, using the same instance as the rest of our code."

The `?external=` parameter tells esm.sh to keep specified dependencies as **bare specifiers** so our import map can intercept them.

### esm.sh Query Parameters

| Parameter | Syntax | Effect |
|-----------|--------|--------|
| `?external=` | `?external=react,react-dom` | **Recommended.** Keeps bare specifiers for import map resolution |
| `?deps=` | `?deps=react@19.2.1` | Forces specific dependency versions at build time |
| `?alias=` | `?alias=react:react@19.2.1` | Rewrites import specifiers at build time (less reliable for no-build) |
| `*` prefix | `https://esm.sh/*pkg@ver` | Marks ALL deps as external (exposes internal deps) |

### Correct Import Map

```json
{
  "imports": {
    "react": "https://esm.sh/stable/react@19.2.4",
    "react/jsx-runtime": "https://esm.sh/stable/react@19.2.4/jsx-runtime",
    "react/jsx-dev-runtime": "https://esm.sh/stable/react@19.2.4/jsx-dev-runtime",
    "react-dom": "https://esm.sh/stable/react-dom@19.2.4",
    "react-dom/client": "https://esm.sh/stable/react-dom@19.2.4/client",
    "use-fireproof": "https://esm.sh/stable/@necrodome/fireproof-clerk@0.0.3?external=react,react-dom",
    "@fireproof/clerk": "https://esm.sh/stable/@necrodome/fireproof-clerk@0.0.3?external=react,react-dom"
  }
}
```

**Key points:**
- The `/stable/` path uses pre-built, cached versions that avoid dependency resolution issues
- `?external=react,react-dom` ensures import map controls React
- Uses `@necrodome/fireproof-clerk@0.0.3` for Clerk auth integration

## Skills vs Commands

This plugin provides both skills and commands. Understanding when each is used:

### Skills (Auto-triggered by Claude)

| Skill | Triggered When | Description |
|-------|----------------|-------------|
| `/vibes:vibes` | User asks to "build an app", "create a todo list", etc. | Generates a single Vibes app |
| `/vibes:design-reference` | User provides a design.html or mockup file | Mechanically transforms design to Vibes app |
| `/vibes:riff` | User asks to "explore ideas", "generate variations", "riff on X" | Generates multiple app variations in parallel |
| `/vibes:sell` | User asks to "monetize", "add billing", "make it SaaS" | Transforms app into multi-tenant SaaS |

Claude automatically selects the appropriate skill based on user intent. The skill description in the YAML frontmatter guides this selection.

### Commands (User-invoked)

| Command | When to Use | Description |
|---------|-------------|-------------|
| `/vibes:sync` | Periodically (every 30 days) or when docs seem stale | Updates cached documentation and import maps |
| `/vibes:update` | When existing app has outdated imports or patterns | Deterministic updater for existing apps |

Commands are explicitly invoked by the user with the `/` prefix.

### Selection Logic

- **vibes vs riff**: "Make me an app" → vibes (single). "Give me 5 variations" → riff (multiple).
- **vibes vs design-reference**: "Build X" → vibes. "Match this design.html" or "use this mockup" → design-reference.
- **vibes vs sell**: "Build X" → vibes. "Build X with billing" or "monetize my app" → sell.
- **sync**: Only when user explicitly runs `/vibes:sync` or skill warns about stale cache.
- **update**: Only when user explicitly runs `/vibes:update` on existing HTML files.

## Sell Skill: Multi-Tenant SaaS

The `/vibes:sell` skill transforms apps into multi-tenant SaaS with Clerk auth and billing.

### Key Components

**Registry Server** (`scripts/registry-server.ts`):
- `GET /registry.json` - Public read of claims, quotas, reserved subdomains
- `GET /check/:subdomain` - Real-time availability checking
- `POST /claim` - Authenticated claiming with quota enforcement (returns 402 if quota exceeded)
- `POST /webhook` - Clerk subscription webhooks for quota updates

**Auth Flows** (in `unified.html`):
- `PasskeySignupFlow`: email → verification → passkey creation → claim
- `PasskeySigninFlow`: passkey-first with email fallback (link or code)
- `ClaimPrompt`: for authenticated users, enforces passkey + quota before claim
- `PasskeyGate`: wraps app, ensures user has passkey before access

**Quota Enforcement**:
- Quotas stored in `registry.json` via Clerk webhooks
- `/claim` returns 402 when `userClaims.length >= quota`
- ClaimPrompt shows "Upgrade Subscription" on 402 response
- LIFO release when subscription quantity decreases

### Registry Schema

```json
{
  "claims": { "alice": { "userId": "user_123", "claimedAt": "2024-..." } },
  "quotas": { "user_123": 3 },
  "reserved": ["admin", "api", "www"],
  "preallocated": {}
}
```

### JWT Validation

The registry server validates Clerk JWTs with:
- Signature verification via `CLERK_PEM_PUBLIC_KEY`
- Expiration and not-before checks
- Authorized party (`azp`) validation with wildcard support (`https://*.domain.com`)

### Environment Variables (Registry Server)

| Variable | Purpose |
|----------|---------|
| `REGISTRY_PATH` | Path to registry.json (default: `/var/www/html/registry.json`) |
| `CLERK_PEM_PUBLIC_KEY` | Clerk's PEM public key for JWT verification |
| `CLERK_WEBHOOK_SECRET` | Svix webhook secret for signature verification |
| `PERMITTED_ORIGINS` | Comma-separated allowed `azp` values (supports wildcards) |
| `PORT` | Server port (default: 3001) |

## exe.dev Deployment

Deploy static Vibes apps to exe.dev VM hosting. Uses pre-installed nginx on persistent VMs.

### Architecture: Separate App and Connect VMs

```
┌─────────────────────────────────────────────────────────────┐
│                      User's Apps                             │
├─────────────────────────────────────────────────────────────┤
│  quicknotes.exe.xyz     │  todoapp.exe.xyz    │  ...        │
│  (static HTML only)     │  (static HTML only) │             │
│  Points to Studio →     │  Points to Studio → │             │
└─────────────────────────┴─────────────────────┴─────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Studio VM                                 │
│                 <name>-studio.exe.xyz                        │
├─────────────────────────────────────────────────────────────┤
│  /opt/fireproof/ (cloned from repo)                         │
│  └── docker-compose.yaml + start.sh                         │
│                                                              │
│  Public URLs (port 8080 exposed via nginx):                  │
│  - https://<studio>.exe.xyz/api                              │
│  - fpcloud://<studio>.exe.xyz?protocol=wss                   │
└─────────────────────────────────────────────────────────────┘
```

### Quick Start

```bash
# Deploy static app to exe.dev
node scripts/deploy-exe.js --name myapp --file index.html

# Deploy Fireproof Connect to a separate Studio VM
node scripts/deploy-connect.js --studio mystudio \
  --clerk-publishable-key "pk_test_..." \
  --clerk-secret-key "sk_test_..."
```

### Connect Studio

Use `deploy-connect.js` to deploy Fireproof Connect to a dedicated Studio VM:
- **Token API**: `https://<studio>.exe.xyz/api`
- **Cloud Sync**: `fpcloud://<studio>.exe.xyz?protocol=wss`

Update your app's `.env` to point to the Studio:
```bash
VITE_CLERK_PUBLISHABLE_KEY=pk_test_...
VITE_API_URL=https://<studio>.exe.xyz/api
VITE_CLOUD_URL=fpcloud://<studio>.exe.xyz?protocol=wss
```

The Studio runs Docker services from the upstream fireproof repo without local reimplementation.

### DNS + SSL Architecture (IMPORTANT)

When using custom domains with exe.dev, there's a critical limitation with wildcard subdomains:

```
┌─────────────────────────────────────────────────────────────────┐
│                         DNS ROUTING                              │
├─────────────────────────────────────────────────────────────────┤
│  yourdomain.com (root)                                           │
│  └─→ A record: points to hosting with SSL cert                  │
│      └─→ Works! ✓                                               │
│                                                                  │
│  *.yourdomain.com (wildcard)                                     │
│  └─→ CNAME: yourapp.exe.xyz                                     │
│      └─→ exe.dev proxy (only has cert for *.exe.xyz)            │
│          └─→ No cert for *.yourdomain.com                       │
│              └─→ ERR_CONNECTION_REFUSED ✗                       │
└─────────────────────────────────────────────────────────────────┘
```

**The Problem:** exe.dev's proxy only terminates SSL for `*.exe.xyz` domains, not custom domains.

**The Solution:** Use the `?subdomain=` query parameter:
```
https://yourdomain.com?subdomain=tenant
```

The `getRouteInfo()` function in unified.html detects this parameter and routes to the tenant app while staying on the root domain with valid SSL.

**To fix wildcard subdomains properly**, you'd need:
1. Wildcard SSL cert (`*.yourdomain.com`) on your own server, OR
2. Keep using `?subdomain=` parameter (works fine, just less pretty URLs)

### Multi-Tenant Support

For apps needing tenant isolation, use client-side subdomain parsing:
- Configure wildcard DNS: `*.myapp.com` → VM IP
- Set up wildcard SSL via certbot (if using your own server)
- JavaScript reads `window.location.hostname` OR `?subdomain=` param
- Uses subdomain as Fireproof database prefix for data isolation

### Prerequisites

- SSH key in `~/.ssh/`
- exe.dev account (run `ssh exe.dev` to create)

### Related Files

- `scripts/deploy-exe.js` - App deployment (static files, AI proxy, registry)
- `scripts/deploy-connect.js` - Connect Studio deployment (Docker-based sync)
- `scripts/lib/exe-ssh.js` - SSH helpers
- `skills/exe/SKILL.md` - App deployment skill
- `skills/connect/SKILL.md` - Connect deployment skill

## Known Issues

### React Context Error Symptoms

If you see these errors, React is being duplicated:
- `TypeError: Cannot read properties of null (reading 'useContext')`
- Page becomes unresponsive after focusing text inputs
- Controlled inputs trigger infinite render loops

**Fix:** Ensure `fireproof-clerk` imports have `?external=react,react-dom`

### VibeContextProvider NOT Required

`VibeContextProvider` is used internally by the vibes.diy platform for database naming. **Standalone apps do NOT need it** - just render your App component directly with the VibesSwitch toggle.

## Temporary Workaround: Local Fireproof Bundle

**Status**: Temporary workaround until `@necrodome/fireproof-clerk` is updated on npm.

**Issue**: The `@necrodome/fireproof-clerk@0.0.3` package from esm.sh has a client-side CID stringification bug where blob URLs show `[object Object]` instead of proper CID strings.

**Current Workaround**:
- `bundles/fireproof-clerk-bundle.js` contains the patched client code
- `deploy-exe.js` automatically uploads this bundle alongside each app (phase 4b)
- Template import map points to `/fireproof-clerk-bundle.js` instead of esm.sh

**To revert when upstream package is fixed**:
1. Update import map in `skills/_base/template.html` to use esm.sh URL:
   ```json
   "use-fireproof": "https://esm.sh/stable/@necrodome/fireproof-clerk@X.X.X?external=react,react-dom",
   "@fireproof/clerk": "https://esm.sh/stable/@necrodome/fireproof-clerk@X.X.X?external=react,react-dom"
   ```
2. Remove `phase4bBundleUpload` function and call from `scripts/deploy-exe.js`
3. Delete `bundles/` directory
4. Remove this section from CLAUDE.md

## Plugin Versioning

When releasing a new version, update the version number in **both** files to comply with Claude Code plugin standards:

1. `.claude-plugin/plugin.json` - The main plugin manifest
2. `.claude-plugin/marketplace.json` - The marketplace metadata (in the `plugins` array)

Both files must have matching version numbers.

## Commit Messages

Do not credit Claude Code when making commit messages.
